#!/bin/dash

repoName=".shrug"
stageDir="$repoName/index"
cwd=$(pwd)
latestCommit=$(sh get-head)
headDir="$repoName/$latestCommit"

# Creating the index directory if it doesn't exist (should this be done?)
if ! test -e "$stageDir"; then
    mkdir "$stageDir"
    exit 1
fi

# Check if the repository has any commits (TODO is this right?)
# if ! sh get-head; then
#     echo "$0: error: your repository does not have any commits yet"
#     exit 1
# fi

stageFiles=$(ls $stageDir)
cwdFiles=$(ls $cwd)
headFiles=$(ls $headDir)

# TODO: String set?
for eachFile in $(echo $stageFiles $cwdFiles $headFiles | tr " " "\n" | sort | uniq | tr "\n" " "); do
    stageFile="$stageDir/$eachFile"
    headFile="$headDir/$eachFile"
    currFile="$cwd/$eachFile"
    # TODO: catch invalid filenames

    # All files exist
    # TODO FIX THIS
    if test -e "$currFile" && test -e "$stageFile" && test -e "$headFile"; then
        if test -z "$(diff $currFile $stageFile)"; then
            if test -z "$(diff $stageFile $headFile)"; then
                echo "$eachFile - same as repo"
            else 
                echo "$eachFile - file changed, changes staged for commit"
            fi
        else
            if test -z "$(diff $stageFile $headFile)"; then
                echo "$eachFile - file changed, changes not staged for commit"
            else 
                echo "$eachFile - file changed, different changes staged for commit"
            fi
        fi
    fi

    # One file missing
    if test -e "$currFile" && test -e "$stageFile" && ! test -e "$headFile"; then
        if test -z "$(diff $currFile $stageFile)"; then
            echo "$eachFile - added to index"
        else
            echo "$eachFile - added to index, file changed"
        fi
    fi

    if test -e "$currFile" && ! test -e "$stageFile" && test -e "$headFile"; then
        echo "$eachFile - untracked"
    fi

    if ! test -e "$currFile" && test -e "$stageFile" && test -e "$headFile"; then
        echo "$eachFile - file deleted"
    fi

    # Two files missing
    if test -e "$currFile" && ! test -e "$stageFile" && ! test -e "$headFile"; then
        echo "$eachFile - untracked"
    fi

    if ! test -e "$currFile" && test -e "$stageFile" && ! test -e "$headFile"; then
        echo "$eachFile - added to index, file deleted"
    fi

    if ! test -e "$currFile" && ! test -e "$stageFile" && test -e "$headFile"; then
        echo "$eachFile - deleted"
    fi
done
