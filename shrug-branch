#!/bin/dash

. shrug-conf

# No shrug directory
if ! test -e $repoName; then
    echo "$thisFile: error: no .shrug directory containing shrug repository exists"
    exit 1
fi

# If no commits, don't allow the use of branches
if ! sh get-head > /dev/null; then
    echo "$thisFile: error: your repository does not have any commits yet"
    exit 1
fi

if test $# = 0; then
    # Print all branches in the repo directory
    # Filter out index, current-branch and commit subdirectories
    ls "$repoName" | tr ' ' '\n' | egrep -v "index|$currBranch|^[0-9]+" 
elif test $# -eq 1; then
    if test $1 = "-d"; then
        # Only -d was supplied
        echo "$thisFile: error: branch name required"
        exit 1
    else
        # Treating first argument as the new branch name
        # Check for invalid branch name
        branchName=$1
        if sh shrug-validname $branchName > /dev/null; then
            newBranch="$repoName/$branchName"
            newBranchBase="$repoName/.$branchName-base"
            if test -e $newBranch; then
                echo "$thisFile: error: branch '$branchName' already exists"
                exit 1
            fi

            # Creating a new branch and save the base commit
            mkdir "$newBranch"
            mkdir "$newBranchBase"

            # Copy over all files over the new branch directory
            cd "$repoName/$currBranch"  # TODO: bad style
            cp $(ls) "../$branchName"  
            cp $(ls) "../.${branchName}-base"  
            cd ../../
            # Copy over the log file, if it exists
            if test -e $logFile; then
                cat $logFile > "$newBranch/.log" 
            fi
        else
            echo "$thisFile: error: invalid branch name '$branchName'"
        fi
    fi
elif test $# -eq 2; then
    if test $1 = "-d"; then
        branchName=$2
        if sh shrug-validname $branchName; then
            # Target branch doesn't exist
            branchDir="$repoName/$branchName"
            if ! test -e $branchDir; then
                echo "$thisFile: error: branch '$branchName' does not exist"
                exit 1
            fi
            # Can't delete the target branch if it's the current branch OR if it's the master branch
            if test $branchName = $master; then
                echo "$thisFile: error: can not delete branch '$master'"
                exit 1
            elif test "$(readlink $repoName/$currBranch)" = $branchName; then
                echo "$thisFile: error: can't delete the current branch you're on"
                exit 1
            fi
            # Throw error if there is unmerged work in the target branch
            # How does git decide this?

            # Deleting the branch
            echo "Deleted branch '$branchName'"
            rm -r "$branchDir"
        else
            echo "$thisFile: error: invalid branch name '$branchName'"
        fi        
    else
        echo "usage: $thisFile [-d] <branch>"
    fi
fi
